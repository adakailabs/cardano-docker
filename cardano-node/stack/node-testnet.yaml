#./entrypoint.sh 


version: '3.7'

volumes:
  grafana-storage:

secrets:
  grafana_admin_password:
    file: ./secrets/grafana_admin_password.txt	
  node_kes.key:
    file: ./secrets/node_kes.key
  node_vrf.key:
    file: ./secrets/node_vrf.key
  node.cert:
    file: ./secrets/node.cert
  producer_private_host_name:
    file: ./secrets/producer_private_host_name
  producer_public_host_name:
    file: ./secrets/producer_public_host_name
  relay0_private_host_name:
    file: ./secrets/relay0_private_host_name
  relay0_public_host_name:
    file: ./secrets/relay0_public_host_name
  relay1_private_host_name:
    file: ./secrets/relay1_private_host_name
  relay1_public_host_name:
    file: ./secrets/relay1_public_host_name

services:
  #---------------------------------------------------------------------------------
  relay0:
    image: adakailabs/cardano-relay:latest
    command:
      - "--type"
      - "relay"
      - "--id"
      - "0"
      - "--secrets_path"
      - "/run/secrets"
      - "--testnet"
    secrets:
      - producer_private_host_name
      - producer_public_host_name
      - relay0_private_host_name
      - relay0_public_host_name
      - relay1_private_host_name
      - relay1_public_host_name
      
    ports:
      - "3000:3001"
    volumes:
      - /home/lovelace/cardano-node/:/home/lovelace/cardano-node/
    deploy:
      restart_policy:
        condition: any
      placement:
        constraints:
          - node.labels.com.adakailabs.relay0 == true
          
  #---------------------------------------------------------------------------------
  relay1:
    image: adakailabs/cardano-relay:latest
    command:
      - "--type"
      - "relay"
      - "--id"
      - "1"
      - "--secrets_path"
      - "/run/secrets"
      - "--testnet"
    secrets:
      - producer_private_host_name
      - producer_public_host_name      
      - relay0_private_host_name
      - relay0_public_host_name
      - relay1_private_host_name
      - relay1_public_host_name
          
    ports:
      - "3001:3001"
    volumes:
      - /home/lovelace/cardano-node/:/home/lovelace/cardano-node/
    deploy:
      restart_policy:
        condition: any
      placement:
        constraints:
          - node.labels.com.adakailabs.relay1 == true

  #---------------------------------------------------------------------------------
  producer0:
    image: adakailabs/cardano-relay:latest
    user: lovelace
    ports:
      - "3002:3001"
    depends_on:
      - "relay0"
      - "relay1"
    secrets:
      - source: node_kes.key
        uid: '1000'
        gid: '1000'
        mode: 0400

      - source: node_vrf.key
        uid: '1000'
        gid: '1000'
        mode: 0400

      - source: node.cert
        uid: '1000'
        gid: '1000'
        mode: 0400

#      - source: node_kes.vkey
#        uid: '1000'
#        gid: '1000'
#        mode: 0400

#      - source: node_vrf.vkey
#        uid: '1000'
#        gid: '1000'
#        mode: 0400

      - source: producer_private_host_name
        uid: '1000'
        gid: '1000'
        mode: 0400

      - source: producer_public_host_name
        uid: '1000'
        gid: '1000'
        mode: 0400
        
      - source: relay0_private_host_name
        uid: '1000'
        gid: '1000'
        mode: 0400

      - source: relay0_public_host_name
        uid: '1000'
        gid: '1000'
        mode: 0400        

      - source: relay1_private_host_name
        uid: '1000'
        gid: '1000'
        mode: 0400        

      - source: relay1_public_host_name
        uid: '1000'
        gid: '1000'
        mode: 0400        
 
    command:
      - "--type"
      - "producer"
      - "--id"
      - "0"
      - "--secrets_path"
      - "/run/secrets"
      - "--testnet"
      
    volumes:
      - /home/lovelace/cardano-node/:/home/lovelace/cardano-node/
    deploy:
      restart_policy:
        condition: any     
      placement:
        constraints:
          - node.labels.com.adakailabs.producer0 == true

  #---------------------------------------------------------------------------------          
  monitor:
    image: adakailabs/cardano-monitor:21.01.02
    depends_on:
      - "relay0"
      - "relay1"
    command:
      - "2" # 2 relays
      - "1" # 1 producer
    ports:
      - "8666:8666"
    volumes:
      - /home/lovelace/cardano-node/:/home/lovelace/cardano-node/
    deploy:
      restart_policy:
        condition: any     
      placement:
        constraints:
          - node.labels.com.adakailabs.monitor == true

  #---------------------------------------------------------------------------------          
  prometheus:
    image: adakailabs/cardano-prometheus:latest
    depends_on:
      - "relay0"
      - "relay1"
    command:
      - "2" # 2 relays
      - "1" # 1 producer
      - "no" #not a producer
    ports:
      - "9090:9090"
    volumes:
      - /home/lovelace/cardano-node/:/home/lovelace/cardano-node/
    deploy:
      restart_policy:
        condition: any     
      placement:
        constraints:
          - node.labels.com.adakailabs.monitor == true
          
  #---------------------------------------------------------------------------------          
  grafana:
    image: grafana/grafana:latest
    depends_on:
      - "relay0"
      - "relay1"    
    secrets:
      - grafana_admin_password
    user: 1000:1000
    ports:
      - "3100:3100"
    volumes:
      - grafana-storage:/var/lib/grafana
    environment:
      #  - GF_PATHS_DATA=/home/lovelace/grafana/var/lib/grafana
      - GF_SECURITY_ADMIN_PASSWORD__FILE=/run/secrets/grafana_admin_password
    deploy:
      restart_policy:
        condition: any     
      placement:
        constraints:
          - node.labels.com.adakailabs.monitor == true

